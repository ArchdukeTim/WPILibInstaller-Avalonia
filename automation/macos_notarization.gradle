import groovy.json.JsonSlurper

ext.notarize = { File application, String id, String username, String password ->
    // Step 1: archive the application.
    println "Archiving application..."
    exec { commandLine "ditto", "-c", "-k", "--keepParent", application.getAbsolutePath(), "/tmp/archive.zip" }

    // Step 2: submit application for notarization.
    println "Submitting application to notarization service..."
    def stdout = new ByteArrayOutputStream()
    def result = exec {
        commandLine "xcrun", "notarytool", "submit", "/tmp/archive.zip", 
                "--apple-id", username, "--password", password,
                "--output-format", "json", "--no-progress", "--wait", "--timeout", "20m"
        standardOutput = stdout
        ignoreExitValue(true)
    }

    if (result.exitValue != 0) {
        println stdout.toString()
        throw new GradleException("The notarization failed!")
    }

    // Step 3: staple the notarization ticket.
    println "Stapling notarization ticket..."
    exec { commandLine "xcrun", "stapler", "staple", "-v", application.getAbsolutePath() }
}